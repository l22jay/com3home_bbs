<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase 게시판</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        #post-container { display: none; }
    </style>
</head>
<body>
    <h1>📌 Supabase 게시판</h1>

    <div id="post-container">
        <h2 id="post-title"></h2>
        <p id="post-content"></p>
        <a href="/" onclick="goHome(event)">⬅️ 목록으로 돌아가기</a>
    </div>

    <div id="post-list"></div>

    <script>
        const SUPABASE_URL = "https://aypexxxatdakzzlgnbng.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...";
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function fetchPosts() {
            const { data, error } = await supabase.from("posts").select("*").order("created_at", { ascending: false });

            if (error) { console.error("데이터 불러오기 실패", error); return; }

            const postList = document.getElementById("post-list");
            postList.innerHTML = "";

            data.forEach(post => {
                const postElement = document.createElement("div");
                postElement.innerHTML = `
                    <h2><a href="/${post.id}" onclick="navigateToPost(event, '${post.id}')">${post.title}</a></h2>
                    <p>${post.content.substring(0, 100)}...</p>
                `;
                postList.appendChild(postElement);
            });
        }

        async function fetchPost(postId) {
            const { data, error } = await supabase.from("posts").select("*").eq("id", postId).single();

            if (error || !data) {
                document.getElementById("post-content").innerText = "게시글을 불러오는 데 실패했습니다.";
                return;
            }

            document.getElementById("post-title").innerText = data.title;
            document.getElementById("post-content").innerHTML = data.content.replace(/\n/g, "<br>");

            // UI 전환
            document.getElementById("post-list").style.display = "none";
            document.getElementById("post-container").style.display = "block";
        }

        function navigateToPost(event, postId) {
            event.preventDefault();
            history.pushState(null, "", `/${postId}`);
            fetchPost(postId);
        }

        function goHome(event) {
            event.preventDefault();
            history.pushState(null, "", "/");
            document.getElementById("post-container").style.display = "none";
            document.getElementById("post-list").style.display = "block";
            fetchPosts();
        }

        // URL에서 ID 감지해 게시글 로드
        window.onload = function () {
            const postId = window.location.pathname.substring(1);
            if (postId) fetchPost(postId);
            else fetchPosts();
        };

        // 뒤로가기/앞으로가기 이벤트 처리
        window.onpopstate = function () {
            const postId = window.location.pathname.substring(1);
            if (postId) fetchPost(postId);
            else goHome(event);
        };
    </script>
</body>
</html>
