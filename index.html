<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase ê²Œì‹œíŒ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        #post-container { display: none; }
    </style>
</head>
<body>
    <h1>ğŸ“Œ Supabase ê²Œì‹œíŒ</h1>

    <!-- âœï¸ ê²Œì‹œê¸€ ì‘ì„± í¼ -->
    <form id="post-form">
        <input type="text" id="title" placeholder="ì œëª©" required>
        <textarea id="content" placeholder="ë‚´ìš©" required></textarea>
        <button type="submit">ê²Œì‹œí•˜ê¸°</button>
    </form>

    <!-- ğŸ“Œ ê°œë³„ ê²Œì‹œê¸€ ë³´ê¸° -->
    <div id="post-container">
        <h2 id="post-title"></h2>
        <p id="post-content"></p>
        <a href="/" onclick="goHome(event)">â¬…ï¸ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    </div>

    <!-- ğŸ“ ê²Œì‹œê¸€ ëª©ë¡ -->
    <div id="post-list"></div>

    <script>
        const SUPABASE_URL = "https://aypexxxatdakzzlgnbng.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF5cGV4eHhhdGRha3p6bGduYm5nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI4MTI3NTEsImV4cCI6MjA1ODM4ODc1MX0.0wEZm3sOESn_5W_6wjCQA1UuQT66pRUpLpJJIl5dHps";
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ğŸ“Œ ê²Œì‹œê¸€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function fetchPosts() {
            const { data, error } = await supabase.from("posts").select("*").order("created_at", { ascending: false });

            if (error) { console.error("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨", error); return; }

            const postList = document.getElementById("post-list");
            postList.innerHTML = "";

            data.forEach(post => {
                const postElement = document.createElement("div");
                postElement.innerHTML = `
                    <h2><a href="/${post.id}" onclick="navigateToPost(event, '${post.id}')">${post.title}</a></h2>
                    <p>${post.content.substring(0, 100)}...</p>
                `;
                postList.appendChild(postElement);
            });
        }

        // âœï¸ ê²Œì‹œê¸€ ì‘ì„±
        document.getElementById("post-form").addEventListener("submit", async (event) => {
            event.preventDefault();
            const title = document.getElementById("title").value;
            const content = document.getElementById("content").value;

            const { data, error } = await supabase.from("posts").insert([{ title, content }]);
            if (error) { console.error("ê²Œì‹œ ì‹¤íŒ¨", error); return; }

            // ì…ë ¥ê°’ ì´ˆê¸°í™” & ìƒˆ ê²Œì‹œê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
            document.getElementById("title").value = "";
            document.getElementById("content").value = "";
            fetchPosts();
        });

        // ğŸ”¹ ê²Œì‹œê¸€ ê°œë³„ ë³´ê¸°
        async function fetchPost(postId) {
            const { data, error } = await supabase.from("posts").select("*").eq("id", postId).single();

            if (error || !data) {
                document.getElementById("post-content").innerText = "ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                return;
            }

            document.getElementById("post-title").innerText = data.title;
            document.getElementById("post-content").innerHTML = data.content.replace(/\n/g, "<br>");

            // UI ì „í™˜
            document.getElementById("post-form").style.display = "none";
            document.getElementById("post-list").style.display = "none";
            document.getElementById("post-container").style.display = "block";
        }

        // ğŸ”¹ `/id`ë¡œ ì´ë™ & ê²Œì‹œê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
        function navigateToPost(event, postId) {
            event.preventDefault();
            history.pushState(null, "", `/${postId}`);
            fetchPost(postId);
        }

        // â¬…ï¸ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
        function goHome(event) {
            event.preventDefault();
            history.pushState(null, "", "/");

            document.getElementById("post-container").style.display = "none";
            document.getElementById("post-form").style.display = "block";
            document.getElementById("post-list").style.display = "block";

            fetchPosts();
        }

        // âœ… URLì—ì„œ ID ê°ì§€í•´ ê²Œì‹œê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
        window.onload = function () {
            const postId = window.location.pathname.substring(1);
            if (postId) fetchPost(postId);
            else fetchPosts();
        };

        // â¬…ï¸ ë’¤ë¡œ ê°€ê¸°/ì•ìœ¼ë¡œ ê°€ê¸° ì§€ì›
        window.onpopstate = function () {
            const postId = window.location.pathname.substring(1);
            if (postId) fetchPost(postId);
            else goHome(event);
        };
    </script>
</body>
</html>
